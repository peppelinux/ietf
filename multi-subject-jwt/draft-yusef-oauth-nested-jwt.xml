<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC7519 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.7519.xml">
<!ENTITY RFC8174 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8174.xml">
<!ENTITY RFC8225 SYSTEM "https://xml2rfc.ietf.org/public/rfc/bibxml/reference.RFC.8225.xml">
]>
<rfc submissionType="IETF" docName="draft-yusef-oauth-nested-jwt-05" category="std" ipr="pre5378Trust200902">
	<!-- Generated by id2xml 1.5.0 on 2020-04-06T20:09:19Z -->
	<?rfc compact="yes"?>
	<?rfc text-list-symbols="o*+-"?>
	<?rfc subcompact="no"?>
	<?rfc sortrefs="yes"?>
	<?rfc symrefs="yes"?>
	<?rfc strict="yes"?>
	<?rfc toc="yes"?>
	<front>
	<title abbrev="Nested JWT">Multi-Subject JSON Web Token (JWT)</title>
	<author fullname="Rifaat Shekh-Yusef" initials="R." surname="Shekh-Yusef">
      <organization>Okta</organization>
      <address>
         <postal>
            <street>Ottawa, Ontario, Canada</street>
         </postal>
         <email>rifaat.s.ietf@gmail.com</email>
      </address>
	</author>

	<author fullname="Rohan Mahy" initials="R." surname="Mahy">
      <organization>Wire</organization>
      <address>
         <postal>
            <street>California, USA</street>
         </postal>
         <email>rohan.mahy@wire.com</email>
      </address>
	</author>
	<date day="25" month="April" year="2022"/>
   
	<workgroup>OAuth Working Group</workgroup>
	<abstract><t>
   This specification defines a mechanism for including multiple subjects in a JWT. 
   A primary subject in an enclosing JWT with its own claims, and a related secondary
   subject in a nested JWT with its own claims. 
   </t>

	</abstract>
	</front>

	<middle>
	<section title="Introduction" anchor="sect-1">
   <t>
   JSON Web Token (JWT) <xref target="RFC7519"/> is a mechanism that is used to
   transfer claims between two parties across security domains.  Nested
   JWT is a JWT in which the payload is another JWT.  The current
   specification does not define a means by which the enclosing JWT
   could have its own Claims Set, only the enclosed JWT would have
   claims.
   </t>

   <t>
   There are a number of use cases where there is a need to represent multiple related subjects in one JWT; 
   a primary subject and a related secondary subject.
   </t>
   
	<t>
    This specification defines a mechanism for including multiple subjects in a JWT. 
   A primary subject in an enclosing JWT with its own claims, and a related secondary
   subject in a nested JWT with its own claims. 
   </t>

	<section title="Terminology" anchor="sect-1.1"><t>
   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in <xref target="RFC8174"/>.</t>

	</section>

	</section>

	<section title="Use Cases" anchor="use-cases">
   <t>
   The following are few use cases that might benefit from such a concept, that fall into two different categories:
   </t>

	<section title="One Issuer Category" anchor="one-issuer">

   <t>
   In the following cases, both JWTs are issued by the same issuer.
   </t>
	
	<section title="Primary Subject with Secondary Authority Subject" anchor="prim-with-sec-authority">
   <t>
   A primary subject with a related secondary subject that has authority over the primary subject, e.g. Child/Parent, Pet/Owner.
   </t>
   <t>
   The secondary user (e.g., parent) logs in to an application (e.g., pharmacy application), gets redirected 
   to the authorization server, authenticates, and asks for permission to access resources (e.g., medication) 
   for the primary subject (e.g., child). 
   The authorization server then issues a JWT with the primary subject in the enclosing JWT and the secondary 
   subject in the nested JWT.
   </t>
   </section>

	<section title="Multiple Primary Subjects" anchor="multiple-primary-subjects">
   <t>
   Two or more primary related subjects e.g. a married couple. The authorization server is setup to provide one of 
   the subjects with permissions to access the other related subject resources.
   </t>
   <t>  
   One user (e.g., wife) logs in to a application (e.g., pharmacy application), gets redirected to the authorization server, 
   authenticates, and asks for permission to access resources (e.g., medication) for the other primary subject (e.g., husband). 
   The authorization server then issues a JWT with the primary subject in the enclosing JWT and the other 
   primary subject in the nested JWT.
   </t>
	</section>

	<section title="Delegation of Authority" anchor="delegation-of-authority">
   <t>
   A primary subject delegates authority over a resource to a secondary subject who acts on behalf of the primary subject, 
   as defined in <xref target="RFC8693"/>. 
   </t>
	</section>

   </section>

   <section title="Multiple Issuers Category" anchor="multiple-issuers">
   <t>
   In the following cases, the JWTs are issued by different issuers.
   </t>

	<section title="STIR" anchor="stir"><t>
   <xref target="RFC8225"/> defines a PASSporT, which is a JWT, that is used to verify
   the identity of a caller in an incoming call.</t>

	<t>
   The PASSporT Extension for Diverted Calls draft <xref target="STIR"/> uses a nested
   PASSporT to deliver the details of an incoming call that get
   redirected.  An authentication service acting for a retargeting
   entity generates new PASSporT and embeds the original PASSporT inside
   the new one.  When the new target receives the nested PASSporT it
   will be able to validate the enclosing PASSporT and use the details
   of the enclosed PASSporT to identify the original target.
   </t>
   <t>
   In this case, the original JWT is issued by the calling service, and the new enclosing 
   JWT is issued by the retargeting service.
   </t>

	</section>

	<section title="Network Service Mesh (NSM)" anchor="nsm"><t>
   Network Service Mesh [NSM] is a mechanism that maps the concept of a
   service mesh in Kubernetes to L2/L3 payloads.</t>

	<t>
   NSM GRPS messages may pass through multiple intermediaries, each of
   which may transform the message.  Each intermediary is expected to
   create its own JWT token, and include a claim that contains the JWT it
   received with the message it has transformed.</t>

   <t>
   In this case, the original JWT is issued by the entity sending the initial message, 
   and the new enclosing JWT is issued by the intermediate entity.
   </t>
	</section>
	

   <section title="Instant Messaging (IM) Services" anchor="im-service">
   <t>
   An IM service needs a way to embed a JWT issued by an intermediary into a JWT issued
   by the AS processing the authorization request.
   </t>
	</section>
   </section>
   </section>


   <section title="Authorization Request" anchor="authz-request">
   <t>
   To allow the AS to differentiate between an authorization request for a single subject 
   and an authorization request for multiple subjects, this document defines the following parameter:

   <list style="hanging" hangIndent="3">
     <t hangText="issuer-hint:">
     <vspace />
     A hint to the AS that the request is for a multi-subject token, which can take one of two values:

   <list style="hanging" hangIndent="3">
     <t hangText="Internal">
     <vspace />
     Indicates that the AS handling the current request will be issuing both enclosing and enclosed JWTs.
      </t>
   </list>   

   <list style="hanging" hangIndent="3">
     <t hangText="External">
     <vspace />
      Indicates that an external entity has issued the JWT to be enclosed, which will be carried in access_token parameter.
      </t>
   </list>   
     </t>
   </list>   
   </t>

   <t>
   If the access_token query parameter is included in the request, then the AS SHOULD embed the provided
   token in the issued token, if the issuer-hint has the "External" value.
   </t>
	</section>


	<section title="JWT Content" anchor="jwt-content"><t>
   The payload of the enclosing JWT is JSON object that contains the
   Claims Set of the primary subject, and one new claim that is used to 
   hold the enclosed JWT and its relation to the primary subject.</t>

	<t>
   This document defines a new claim, "rsub" (Related Subject) Claim, that is used 
   to contain the enclosed JWT and its relation to the primary subject. The "rsub" 
   contains two claims:  

   <list style="hanging" hangIndent="3">
     <t hangText="rel:">
     <vspace />
      Defines the relationship between the enclosed JWT and the enclosing JWT. It can 
      take one of the values defined in section <xref target="token-relationship"/> </t>
   </list>   

   <list style="hanging" hangIndent="3">
     <t hangText="jwt:">
     <vspace />
      Contains the enclosed JWT.</t>
   </list>   
   </t>

	</section>


   <section title="Token Relationship" anchor="token-relationship">
   <t>
   The following relathionship types are defined by this specification:

   <list style="hanging" hangIndent="3">
     <t hangText="urn:ietf:params:oauth:subject-type:authority">
     <vspace />
     Indicates that the subject in the enclosed JWT has authority over the subject in the enclosing JWT. 
     </t>
     <t>
     This URN could be used in the child/parent use case described in <xref target="prim-with-sec-authority"/>.
     </t>
   </list>   

   <list style="hanging" hangIndent="3">
      <t hangText="urn:ietf:params:oauth:subject-type:primary">
      <vspace />
      Indicates that the subject in the enclosed JWT is related primary subject</t>
      <t>
      This URN could be used in the married couple use case described in <xref target="multiple-primary-subjects"/>.
      </t>
   </list>   


   <list style="hanging" hangIndent="3">
     <t hangText="urn:ietf:params:oauth:subject-type:actor">
     <vspace />
     Indicates that the subject in the enclosed JWT is acting on behalf of the primary subject</t>

     <t>
      This URN could be used in the delegation use case described in <xref target="delegation-of-authority"/>.
      </t>
   </list>   

   <list style="hanging" hangIndent="3">
     <t hangText="urn:ietf:params:oauth:subject-type:original">
     <vspace />
     Indicates that the subject in the enclosed JWT is the original JWT that resulted in the primary subject JWT</t>

     <t>
      This URN could be used in all the use cases described in <xref target="multiple-issuers"/>.
      </t>
   </list>   

   </t>

	</section>

	<section title="Example" anchor="example">
   
   <t>
   The following example is for a multi-subject token that represents a child/parent relashionship.
   The enclosing JWT represents the primary user, the child in this case, and the enclosed token in 
   the "rsub" claim represents the secondary user, the parent in this case.
   </t>

   <figure><artwork><![CDATA[
{
  "alg": "HS256",
  "typ": "JWT",
}
{
   "sub": "1234567890",
   "name": "John Doe",
   "iat": 1516239022,
   "rsub": {
      “rel” :  "urn:ietf:params:oauth:subject-type:authority"
      “jwt” : {
         "sub": "9876543210",
         "name": "Alice Doe",
         "iat": 1516239022,
      }
   }
}
]]></artwork>
	</figure>

   <t>
   In this use case, both JWTs are issued by the same entity handling the authorization request.
   </t>

	</section>

	<section title="Security Considerations" anchor="sect-7">
   <t>
   The existing security considerations apply to the use cases where the JWTs are issued by the same entity.
   Allowing more than one subject to access the same account might open the door for potential abuse.
   Care must be taken to ensure that when a secondary subject is added to an account that an adequate approval process is in place.
   </t>

   <t>
   In the multiple issuers use cases, the entity handling the incoming authorization request that contains a JWT MUST validate 
   the token and ensure that it is coming from a trusted entity, before attempting to embed that JWT into a new multi-subject JWT issued 
   by the AS.
   </t>

	</section>

	<section title="IANA Considerations" anchor="sect-8"><t>
   TODO</t>

	</section>

	<section title="Acknowledgments" anchor="sect-9"><t>
   TODO</t>
<figure>
<artwork><![CDATA[

]]></artwork>
</figure>

	</section>

	</middle>

	<back>
	<references title="Normative References">
	&RFC7519;
	&RFC8174;
	</references>
	<references title="Informative References">
	&RFC8225;

 	<reference anchor="RFC8693">
      <front>
         <title>OAuth 2.0 Token Exchange</title>
         <author fullname="M. Jones" initials="M." surname="Jpnes">
         </author>
         <author fullname="A. Nadalin" initials="A." surname="Nadalin">
         </author>
         <author fullname="B. Campbell" initials="B." surname="Campbell"></author>
         <author fullname="J. Bradley" initials="J." surname="Bradley"></author>
         <author fullname="C. Mortimore" initials="C." surname="Mortimore"></author>
         <date month="October" year="2018"/>

      </front>
	</reference>

	<reference anchor="STIR">
      <front>
         <title>PASSporT Extension for Diverted Calls</title>
         <author fullname="J. Peterson" initials="J." surname="Peterson">
         </author>
         <date month="October" year="2018"/>
      </front>
	</reference>
	</references>
   
	</back>

	</rfc>
	

